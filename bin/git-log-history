#! /usr/bin/env bash
# shellcheck disable=2068

args=()
while (( $# > 0 )); do
    case "$1" in
        --)
            file="$2"; shift
            break
            ;;
        *)
            args+=("$1"); shift
            ;;
    esac
done

export file
export glhdir="$(mktemp -d --tmpdir glh.$$.XXXXXX)"

git_log() {
    git log ${args[@]} --color=always --format="format:%Cgreen%h%Creset %C(cyan)<%as>%Creset%C(Yellow)|%-d|%Creset%s" -- ${file} |
        tr -s '|' | perl -0 -pe 's/\n/\0/gm' | sed 's/|/\n/g;/^[[:space:]]*$/d;s/^ //g;s/\n /\n/g'
}
export -f git_log

git_list_files_in_commit() {
    [[ -z "$1" ]] && return 0
    local f="${glhdir}/${1}"
    if [[ -r "$f" ]]; then
        cat "$f"
    else
        git diff-tree --no-commit-id --name-only "$1" -r | tee "$f"
    fi
    return 0
}
export -f git_list_files_in_commit

[[ -n "$file" ]] && LIST_LABEL=" <alt-enter>: view, <alt-d>: diff vs. now "

fzf \
    --read0 \
    --ansi \
    --layout=reverse \
    --multi \
    --no-sort \
    --wrap \
    --preview "git show --color=always {1} -- ${file}" \
    --border rounded \
    --preview-window=right,75%,wrap,border-line \
    --style full \
    --margin 0 \
    --padding 0 \
    --list-label "$LIST_LABEL" \
    --list-label-pos "bottom" \
    --border-label " git log${args:+ }${args[*]} ${file:+-- $file }(?: toggle view) " \
    --gap 1 \
    --gap-line '╍' \
    --bind "start:reload( git_log $* )" \
    --bind "focus:transform-footer(git_list_files_in_commit {1} | head -n 30)" \
    --bind "focus:+transform-footer-label(git_list_files_in_commit {1} | wc -l | xargs printf ' %d files ')" \
    --bind "?:change-preview-window(bottom,75%,wrap|right,75%,wrap)" \
    --bind "alt-enter:execute([[ -n '$file' ]] && install -D <(git show {r1}:./${file}) ${glhdir}/{r1}.d/${file} && nvim ${glhdir}/{r1}.d/${file} || :)" \
    --bind "alt-d:execute([[ -n '$file' ]] && install -D <(git show {r1}:./${file}) ${glhdir}/{r1}.d/${file} && nvim -d ${glhdir}/{r1}.d/${file} ${file} || :)" \
    --color "border:#526760" \
    --color "label:#ffffff:bold" \
    --color "bg:#232136" \
    --color "footer:#ffffff:italic" \
    --highlight-line \
    --marker-multi-line '┏┃┗' \
    --accept-nth=1 \

rm -rf "$glhdir"
